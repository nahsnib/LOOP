<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ä¸‹åˆ—è»Šï¼šç¶²é å¯¦é©—ç‰ˆ</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; padding: 20px; }
        #log { 
            background: #000; height: 250px; overflow-y: scroll; 
            padding: 10px; border: 1px solid #444; margin-top: 10px;
            font-family: monospace; font-size: 14px; line-height: 1.5;
        }
        .map { display: flex; justify-content: space-around; margin: 20px 0; flex-wrap: wrap; }
        .loc { border: 2px solid #555; padding: 10px; border-radius: 8px; text-align: center; min-width: 80px; margin: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #444; color: white; border: none; border-radius: 4px; }
        button:active { background: #222; }
        .container { margin: 0 auto; max-width: 600px; text-align: center; }
        .status { font-weight: bold; color: #ffcc00; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>åœ°ä¸‹åˆ—è»Šï¼šç¶²é åŸå‹</h1>
        <div id="status-bar" class="status">è¼‰å…¥ä¸­...</div>

        <div class="map">
            <div id="loc-0" class="loc">ç¥ç¤¾ (0)</div>
            <div id="loc-1" class="loc">é†«é™¢ (1)</div>
            <div id="loc-2" class="loc">éƒ½å¸‚ (2)</div>
            <div id="loc-3" class="loc">å­¸æ ¡ (3)</div>
            <div id="loc-4" class="loc" style="border-color: #007bff;">è»Šç«™ (4)</div>
        </div>

        <div id="controls">
            <button py-click="move_to(0)">å‰å¾€ 0</button>
            <button py-click="move_to(1)">å‰å¾€ 1</button>
            <button py-click="move_to(2)">å‰å¾€ 2</button>
            <button py-click="move_to(3)">å‰å¾€ 3</button>
            <button py-click="move_to(4)">å‰å¾€ 4</button>
            <hr style="border: 0.5px solid #333; margin: 15px 0;">
            <button py-click="do_ask()">è©¢å•æƒ…å ± (1AP)</button>
            <button py-click="next_phase()" style="background: #28a745;">çµæŸå›åˆ</button>
        </div>

        <h3 style="margin-top: 20px; text-align: left;">éŠæˆ²æ—¥èªŒ</h3>
        <div id="log"></div>
    </div>

    <script type="py" config="./pyscript.json">
import js
import random
from actions import ActionManager
from settings import STATION_ID
from mechanics import process_arrival, calculate_sunrise_move, check_sanity_status
from scenario_gen import ScenarioBuilder
from abilities import AbilityEngine
from models import Grave
from settings import SCRIPTS_DB

# --- ç›´æ¥æŠŠ GameEngine å¯«åœ¨é€™è£¡ï¼Œé¿å…è®€å–å¤–éƒ¨ main.py ---
class GameEngine:
    def __init__(self, logger_callback=None):
        self.day = 1
        self.max_days = 4
        self.is_game_over = False
        self.graves = []
        self.ap = 5 
        self.blocked_locations = []
        self.log_func = logger_callback if logger_callback else print

        builder = ScenarioBuilder()
        self.characters, self.scripts = builder.build()
        
        self.main_rule = self.scripts[0].get('rule_tag', 'default')
        self.sub_rule = self.scripts[1].get('rule_tag', 'default')
        self.foreshadow_data = self.scripts[2]
        
        self.ability_engine = AbilityEngine(SCRIPTS_DB.get("Role_Data", {}))
        self.log(f"ğŸ“‹ åŠ‡æœ¬æ§‹ç¯‰å®Œæˆ: {self.main_rule}")
        self._assign_random_intrigue()

    def log(self, message):
        if message: self.log_func(message)

    def _assign_random_intrigue(self):
        if self.characters:
            random.choice(self.characters).intrigue = 1
            self.log("ğŸ‘ï¸ åˆå§‹é™°è¬€å·²æ½›ä¼...")

    def phase_morning(self):
        self.log(f"\nğŸƒ ç¬¬ {self.day} å¤©æ—©ä¸Šï¼šè‡ªå‹•ç§»å‹•")
        for c in self.characters[1:]: # è·³éç©å®¶
            if not c.is_dead:
                new_loc = calculate_sunrise_move(c.location, self.blocked_locations)
                process_arrival(c, new_loc, self.log)

# --- UI æ©‹æ¥é‚è¼¯ ---
def web_log(msg):
    log_div = js.document.getElementById("log")
    if log_div:
        div = js.document.createElement("div")
        div.innerHTML = str(msg)
        log_div.appendChild(div)
        log_div.scrollTop = log_div.scrollHeight

# åˆå§‹åŒ–
try:
    engine = GameEngine(logger_callback=web_log)
    actions = ActionManager(engine)
    player = engine.characters[0]
except Exception as e:
    web_log(f"âŒ éŒ¯èª¤: {e}")

def update_ui():
    status = js.document.getElementById("status-bar")
    status.innerHTML = f"Day: {engine.day} | AP: {engine.ap} | ä½ç½®: {player.location} | è·æ¥­: {player.role}"
    for i in range(5):
        loc_div = js.document.getElementById(f"loc-{i}")
        loc_div.style.background = "#333" if i == player.location else "transparent"

def move_to(loc_id):
    success, msg = actions.move(player, int(loc_id))
    web_log(msg)
    update_ui()

def do_ask():
    success, msg = actions.ask(player)
    web_log(msg)
    update_ui()

def next_phase():
    # é€™è£¡åŸ·è¡Œæ—©ä¸Šç§»å‹•é‚è¼¯
    engine.phase_morning()
    engine.ap = 5
    engine.day += 1
    web_log(f"--- é€²å…¥ç¬¬ {engine.day} å¤© ---")
    update_ui()

update_ui()
    </script>
</body>
</html>
